#!/bin/bash
# Limoji 1.0.0

readonly VERSION="1.0.0"

parent_path=$( cd "$(dirname "${BASH_SOURCE[0]}")" || exit ; pwd -P )

cd "$parent_path" || exit

# A few values so the script can run in color
COL_NC='\e[0m' # No Color
COL_LIGHT_RED='\e[1;31m'
COL_LIGHT_GREEN='\e[1;32m'
COL_LIGHT_BLUE='\e[1;94m'
COL_LIGHT_YELLOW='\e[1;93m'
TICK="${COL_NC}[${COL_LIGHT_GREEN}✓${COL_NC}]"
CROSS="${COL_NC}[${COL_LIGHT_RED}✗${COL_NC}]"
INFO="${COL_NC}[${COL_LIGHT_YELLOW}i${COL_NC}]"
QUESTION="${COL_NC}[${COL_LIGHT_BLUE}?${COL_NC}]"

# A function that copies the selected emoticon to the clipboard
# Works on both X11 and Wayland
copyToClipboard() {
    if [[ "$XDG_SESSION_TYPE" = "x11" ]]; then
        xclip -selection c
    else
        wl-copy
    fi
}

# A function that prints the selected emoticon to the console
printEmoticon() {
    printf -- '%b %b%s was copied to the clipboard successfully:%b\n' "${TICK}" "${COL_LIGHT_GREEN}" "$1" "${COL_NC}"
    printf -- '%b' "${!1}" | tee >(copyToClipboard)
    printf -- '%s\n' ""
}

printHelp() {
cat << EOF
Usage: limoji <emoticon>
  -e, --emoticons Show a list of the available emoticons
  -h, --help      Show this list
  -i, --info      Show info about the project
  -r, --random    Print a random emoticon
  -v, --version   Display Limoji's version
  
For more information you can visit our GitHub repository: https://github.com/GEROGIANNIS/Limoji"

EOF
}

printInfo() {
cat << EOF
${INFO} Limoji is an open source tool that makes it easy to choose between hundreds of cool ASCII emoticons and share them with your friends, all done using the terminal!
All you have to do is pick the right one or let Limoji choose it for you!'

EOF
}

# Function that picks a random emoticon name
fetchRandomName() {
    # Generate a random number between 1 and ascii line count
    randomLine=$(( 2 + RANDOM % (ASCII_LINES - 1) ))

    # Fetch emoticon's name from the selected line
    randomName=$(sed "${randomLine}q;d" ascii | cut -d= -f1)
}

randomEmoticon() {
    # Picks a random emoticon name
    fetchRandomName

    # Print the emoticon and copy it to the clipboard
    printEmoticon "$randomName"

    # Ask the user if he wants another emoticon
    printf -- '%b Do you want another one? (y/n) ' "${QUESTION}"
    read -n 1 -r
    printf -- '%s\n' ""
}

# Function that creates a list of the available emoticons
listEmoticons() {
    # Repeat for every single line
    for (( c=2; c<=ASCII_LINES; c++ )); do
        # Read emoticon's name
        name=$(sed "${c}q;d" ascii | cut -d= -f1)

        # Print the name followed by the emoticon itself
        printf -- '%b:\n%b\n\n' "$name" "${!name}"
    done
}

# Prints an error message on invalid input
invalidArgument() {
    printf -- '%b %bInvalid argument!%b\n' "${CROSS}" "${COL_LIGHT_RED}" "${COL_NC}"
    printf -- '%s\n' "Try 'limoji --help' for a list of available commands."
}

# Fetch all emoticons from the file
source ascii

# Store the number of emoticons in a variable
ASCII_LINES=$(wc -l < ascii)

# Check if current session is X11
# Otherwise, check if it is Wayland
# Anything else is unsupported
case "${XDG_SESSION_TYPE}" in
    (x11)
        # Verify xclip has been installed
        if ! command -v xclip >/dev/null 2>&1; then
            printf -- '%b X11 detected\n' "${INFO}"
            printf -- '%b %bxclip is required for copying text to the clipboard%b\n' "${CROSS}" "${COL_LIGHT_RED}" "${COL_NC}"
            exit 2
        fi
    ;;
    (wayland)
        # Verify wl-clipboard has been installed
        if ! command -v wl-copy >/dev/null 2>&1; then
            printf -- '%b Wayland detected\n' "${INFO}"
            printf -- '%b %bwl-clipboard is required for copying text to the clipboard%b\n' "${CROSS}" "${COL_LIGHT_RED}" "${COL_NC}"
            exit 2
        fi
    ;;
    (*)
        printf -- '%b %bYour system is not supported yet, please create an issue here:%b\n' "${CROSS}" "${COL_LIGHT_RED}" "${COL_NC}"
        printf -- '%s\n' "https://github.com/GEROGIANNIS/Limoji/issues/new/choose"
        exit 1
    ;;
esac

main() {
    # Fail fast
    (( ${#} == 0 )) && { invalidArgument; exit 1; }

    if [[ "$1" = --emoticons ]] || [[ "$1" = -e ]]; then
        listEmoticons
    elif [[ "$1" = --help ]] || [[ "$1" = -h ]]; then
        printHelp
    elif [[ "$1" = --info ]] || [[ "$1" = -i ]]; then
        printInfo
    elif [[ "$1" = --random ]] || [[ "$1" = -r ]]; then
        # Picks a random emoticon
        randomEmoticon

        # If the user replies with a 'Yes', repick one
        while [[ $REPLY =~ ^[Yy]$ ]]; do
            randomEmoticon
        done
    elif [[ "$1" = --version ]] || [[ "$1" = -v ]]; then
        printf -- 'Limoji %b\n' "${VERSION}"
    # If input contains only alphanumeric characters
    elif [[ "$1" =~ ^[[:alnum:]]+$ ]]; then
        # Convert all uppercase characters to lowercase
        set "$(printf -- '%b' "$1" | tr '[:upper:]' '[:lower:]')"

        # Check if the selected emoticon exists
        if [[ -n "${!1}" ]]; then
            printEmoticon "$1"
        else
            printf -- "%b %bThe specified emoji doesn't exist!%b\n" "${CROSS}" "${COL_LIGHT_RED}" "${COL_NC}"
            printf -- '%s\n' "Try 'limoji --emoticons' for a list of available emojis."
        fi
    else
        invalidArgument
    fi
}

main "${@}"
